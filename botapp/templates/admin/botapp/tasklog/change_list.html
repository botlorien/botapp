{% extends "admin/change_list.html" %}
{% load static %}

{% block content %}
  {{ block.super }}

  <style>
    .chart-section {
      margin-top: 40px;
      padding: 20px;
      border-radius: 8px;
      background-color: var(--panel);
      border: 1px solid var(--border);
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }

    .chart-section h3 {
      margin-bottom: 12px;
      color: var(--text);
    }

    .chart-section canvas {
    background-color: var(--panel);
    border-radius: 6px;
    border: 1px solid var(--border);
    padding: 10px;
    max-width: 100%;
    height: 300px !important; /* üëà altura fixa */
    }


    .chart-section button {
      margin-top: 12px;
      background: var(--blue);
      color: #fff;
      border: none;
      border-radius: 6px;
      padding: 6px 12px;
      font-weight: 600;
      cursor: pointer;
    }

    .chart-section button:hover {
      background-color: #0a58ca;
    }
  </style>

  <div class="chart-section">
    <h2>üìä Graficos</h2>
  </div>

  <div class="chart-section">
    <h3>üìä Execu√ß√µes por Status</h3>
    <canvas id="statusChart"></canvas>
    <button onclick="downloadChart('statusChart')">üì• Baixar PNG</button>
  </div>

  <div class="chart-section">
    <h3>üìä Execu√ß√µes por Bot</h3>
    <canvas id="botChart"></canvas>
    <button onclick="downloadChart('botChart')">üì• Baixar PNG</button>
  </div>

  <div class="chart-section">
    <h3>üìÖ Execu√ß√µes por M√™s</h3>
    <canvas id="monthChart"></canvas>
    <button onclick="downloadChart('monthChart')">üì• Baixar PNG</button>
  </div>

  <div class="chart-section">
    <h3>‚è±Ô∏è Tempo M√©dio de Execu√ß√£o por Tarefa (segundos)</h3>
    <canvas id="durationChart"></canvas>
    <button onclick="downloadChart('durationChart')">üì• Baixar PNG</button>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    function getChartColors() {
      const styles = getComputedStyle(document.body);
      return {
        text: styles.getPropertyValue('--text').trim(),
        panel: styles.getPropertyValue('--panel').trim(),
        border: styles.getPropertyValue('--border').trim()
      };
    }

    function createBarChart(id, labels, data, label, bgColor) {
      const colors = getChartColors();
      new Chart(document.getElementById(id), {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: label,
            data: data,
            backgroundColor: bgColor,
          }]
        },
        options: {
  responsive: true,
  plugins: {
    title: {
      display: true,
      color: getComputedStyle(document.body).getPropertyValue('--text').trim(),  // din√¢mico!
      font: {
        size: 16,
        weight: 'bold',
        family: 'Inter'
      },
      padding: {
        top: 10,
        bottom: 20
      }
    },
    legend: {
      labels: {
        color: getComputedStyle(document.body).getPropertyValue('--text-muted').trim()
      }
    }
  },
  scales: {
    x: {
      ticks: {
        color: getComputedStyle(document.body).getPropertyValue('--text').trim()
      },
      grid: {
        color: getComputedStyle(document.body).getPropertyValue('--border').trim()
      }
    },
    y: {
      ticks: {
        color: getComputedStyle(document.body).getPropertyValue('--text').trim()
      },
      grid: {
        color: getComputedStyle(document.body).getPropertyValue('--border').trim()
      }
    }
  }
}

      });
    }

    function downloadChart(id) {
      const canvas = document.getElementById(id);
      const link = document.createElement('a');
      link.download = `${id}.png`;
      link.href = canvas.toDataURL('image/png');
      link.click();
    }

    // Renderiza os gr√°ficos com base nas vari√°veis passadas do Python
    createBarChart('statusChart', {{ chart_status_labels|safe }}, {{ chart_status_values|safe }}, 'Execu√ß√µes por Status', '#198754');
    createBarChart('botChart', {{ chart_bot_labels|safe }}, {{ chart_bot_values|safe }}, 'Execu√ß√µes por Bot', '#0d6efd');
    createBarChart('monthChart', {{ chart_month_labels|safe }}, {{ chart_month_values|safe }}, 'Execu√ß√µes por M√™s', '#6f42c1');
    createBarChart('durationChart', {{ chart_duration_labels|safe }}, {{ chart_duration_values|safe }}, 'M√©dia de Dura√ß√£o (s)', '#fd7e14');
  </script>
{% endblock %}
